<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <style>
        .border {
            background-color: black;
            color: white;
            font-size: 20px;
            border: 2px solid black;
            border-radius: 5px;
        }
        .borders{
            display:inline;
            background-color: red;
            color:white;
            margin-top:7px;
            border:2px solid yellow;
            font-size: 13px;
            border-radius: 7px;

        }

        .white {
            color: white;
        }

        #verification {
            display: none;
        }
        #userexists{
            display:none;
        }
        #success{
            display:none;
        }
        #otpsent{
            display:none;
            border:2px solid red;
        }

    </style>
</head>

<body>
    <h1 class="text-center">HEY USER WELCOME!!</h1>
    <form action="" method="POST" id="registrationform">
        <div class="form-row mx-1">
            <div class="col-md-6 mb-3">
                <label for="validationDefault01" class="border">NAME</label>
                <input type="text" class="form-control" id="name" placeholder="Enter Your Name" default="" required>
            </div>
        </div>
        <div class="form-row mx-1">
            <div class="col-md-6 mb-3">
                <label for="validationDefault02" class="border">ADDRESS</label>
                <input type="text" class="form-control" id="address" placeholder="Enter Your Address" required>
            </div>
            <div class="col-md-3 mb-3">
                <label for="validationDefault03" class="border">GENDER</label>
                <select class="custom-select" id="gender" required>
                    <option selected disabled value="">Choose...</option>
                    <option>MALE</option>
                    <option>FEMALE</option>
                </select>
            </div>
            <div class="col-md-3 mb-3 mx-1">
                <label for="validationDefault04" class="border">MOBILE NUMBER</label><br>
                <label for="validationDefault05" class="borders">**Please Check The Recaptcha before Sending The OTP</label>
                <input type="text" class="form-control" id="number" placeholder="" required>
                <button class="btn btn-primary" type="button" onclick="sendotp()">SEND OTP</button>
            </div>
            <div id="recaptcha-container"></div>
            <div class="col-md-3 mb-3 mx-1">
                <label for="validationDefault06" class="border">ENTER THE OTP</label>
                <input type="text" class="form-control" id="verificationCode" placeholder="******" required>
            </div>
            <p id="otpsent">OTP SENT</p>
        </div>
        <div class="form-group mx-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="invalidCheck2" required>
                <label class="form-check-label" for="invalidCheck2">
                    Agree to terms and conditions
                </label>
            </div>
        </div>
        <div class="text-center">
            <button class="btn btn-primary" type="submit">CREATE ACCOUNT</button>
            <button class="btn btn-primary"><a class="white" href="index.html">BACK TO HOME</a></button>
        </div>
        <!-- =================================================================================== -->
    </form>
    <h1 id="userexists"> A USER IS ALREADY REGISTERED WITH THIS NUMBER!!</h1>
    <h1 id="success">YOU ARE SUCCESSFULLY SIGNED IN</h1>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-analytics.js"></script>
    <script>
     
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyBQUpIYvs0WKfP5IMD4TE2IWTvpb5U34Cc",
            authDomain: "portfoliomanagement-16f09.firebaseapp.com",
            databaseURL: "https://portfoliomanagement-16f09.firebaseio.com",
            projectId: "portfoliomanagement-16f09",
            storageBucket: "portfoliomanagement-16f09.appspot.com",
            messagingSenderId: "505793158040",
            appId: "1:505793158040:web:14b9466a349235ef8b69ed",
            measurementId: "G-MRCWJ4R5RJ"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        let formMessage = firebase.database().ref("register")
        window.onload = function () {
            render();
        }; 
        function render() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');
            recaptchaVerifier.render()
        }
        function sendotp(){
            var number = document.querySelector('#number').value;
            firebase.auth().signInWithPhoneNumber(number, window.recaptchaVerifier).then(function (confirmationResult) {

                window.confirmationResult = confirmationResult;
                codeResult = confirmationResult;
                document.getElementById('otpsent').style.display="inline";
                document.getElementById('recaptcha-container').style.display="none";
            }).catch(function (error) {
                document.getElementById('otpsent').style.display="inline";
                document.getElementById('otpsent').innerHTML=error.message;
                
            })
        }
        document.getElementById('registrationform').addEventListener('submit', formSubmit);
        function formSubmit(e) {
            e.preventDefault();
            var name = document.querySelector('#name').value;
            var number = document.querySelector('#number').value;
            var address = document.querySelector('#address').value;
            var gender = document.querySelector('#gender').value;
            var code = document.getElementById('verificationCode').value;
           const mynumber = document.querySelector('#number').value;
            codeResult.confirm(code).then(function (result) {
                var user = result.user;
                console.log(user);
                firebase.database().ref('register').child(mynumber).once('value', function (snapshot) {
                    var childdata = snapshot.val()
                    if (childdata != null) {
                        document.getElementById('userexists').style.display="block";
                        document.getElementById('registrationform').style.display="none";
                        document.getElementById('registrationform').reset();
                    } else {
                        sendMessage(name, number, address, gender);
                        document.getElementById('success').style.display="block";
                        document.getElementById('registrationform').style.display="none";
                        document.getElementById('registrationform').reset();

                    }
                })                
            }).catch(function (error) {
                document.getElementById('userexists').style.display="block";
                document.getElementById('registrationform').style.display="none";
                document.getElementById('userexists').innerHTML=error.message;           
                
            })
           
        }


        function sendMessage(name, number, address, gender) {
            // let newFormMessage = formMessage.push();
            formMessage.child(number).set({
                name: name,
                number: number,
                address: address,
                gender: gender
            });
        }

    </script>
</body>

</html>